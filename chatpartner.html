<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tasquirre â€“ Partner Chat</title>
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />

<style>
:root {
  --bg: #fff6e6;
  --bg-soft: #ffe8c7;
  --round-soft: #f1d2b2;
  --text-main: #5a2c13;
  --text-sub: #a96b3d;
  --accent: #c5652c;
  --accent-deep: #824119;
  --border-soft: #f0d4af;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif}

body{
  background:var(--bg);
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
  padding:1rem 0;
}

.screen{
  width:100%;
  max-width:428px;
  height:calc(100vh - 2rem);
  background:var(--bg);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* HEADER */
.app-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0.7rem 0.9rem;
  background:var(--bg-soft);
}

.header-left{
  display:flex;align-items:center;gap:0.5rem;
}

.back-btn{
  width:38px;height:38px;
  display:flex;justify-content:center;align-items:center;
  background:var(--round-soft);
  border:none;border-radius:50%;
  font-size:1.2rem;
  cursor:pointer;
  color:var(--accent);
}

.header-main{
  display:flex;
  flex-direction:column;
}

.chat-title{
  font-size:0.95rem;
  font-weight:600;
  color:var(--accent-deep);
}

.chat-sub{
  font-size:0.75rem;
  color:var(--text-sub);
}

/* CHAT BODY */
.chat-body{
  flex:1;
  padding:0.8rem 0.9rem;
  overflow-y:auto;
  background:linear-gradient(180deg,#fff6e6,#ffe8c7);
}

.msg-row{
  display:flex;
  margin-bottom:0.4rem;
}

.msg-row.partner{justify-content:flex-end;}
.msg-row.user{justify-content:flex-start;}

.msg-bubble{
  max-width:75%;
  padding:0.55rem 0.8rem;
  border-radius:16px;
  font-size:0.8rem;
  line-height:1.4;
}

.msg-partner{
  background:linear-gradient(135deg,#c5652c,#f4984a);
  color:#fff;
  border-bottom-right-radius:4px;
}

.msg-user{
  background:#fff;
  color:var(--text-main);
  border-bottom-left-radius:4px;
  box-shadow:0 3px 8px rgba(0,0,0,.06);
}

.msg-time{
  font-size:0.68rem;
  opacity:0.8;
  margin-top:2px;
}

/* INPUT */
.chat-input-bar{
  padding:0.5rem 0.7rem 0.7rem;
  background:#fff;
  border-top:1px solid var(--border-soft);
  display:flex;
  gap:0.4rem;
  align-items:flex-end;
}

.chat-input-bar textarea{
  flex:1;
  resize:none;
  min-height:38px;
  max-height:80px;
  border-radius:14px;
  border:1px solid var(--border-soft);
  padding:0.45rem 0.7rem;
  font-size:0.8rem;
  outline:none;
}

.send-btn{
  width:42px;height:42px;
  border-radius:50%;
  border:none;
  background:linear-gradient(135deg,#c5652c,#f4984a);
  display:flex;justify-content:center;align-items:center;
  color:#fff;
  font-size:1.3rem;
  cursor:pointer;
}

/* SMALL TASK TAG */
.task-chip{
  font-size:0.7rem;
  color:var(--text-sub);
}
</style>
</head>
<body>

<div class="screen" id="screen">

  <header class="app-header">
    <div class="header-left">
      <button class="back-btn" onclick="goBack()">
        <i class="bx bx-arrow-back"></i>
      </button>
      <div class="header-main">
        <div class="chat-title" id="chatTitle">Chat dengan User</div>
        <div class="chat-sub" id="chatSubtitle">Task:</div>
      </div>
    </div>
    <i class="bx bx-dots-horizontal-rounded" style="color:var(--text-sub);font-size:1.4rem;"></i>
  </header>

  <div class="chat-body" id="chatBody"></div>

  <div class="chat-input-bar">
    <textarea id="chatInput" placeholder="Tulis pesan ke user..."></textarea>
    <button class="send-btn" onclick="sendMessage()">
      <i class="bx bx-send"></i>
    </button>
  </div>

</div>

<script>
/* GET TASK + ID */
function seedPartnerTaskIfEmpty(){
  let t = localStorage.getItem("partnerTaskTasquirre");
  if(!t){
    const demo = {
      id:"TSQ-X71P9",
      jobdesk:"Copywriting 2 halaman A4",
      user:"Teresa",
      price:80000,
      status:"ongoing",
      progress:25,
      createdAt:Date.now()
    };
    localStorage.setItem("partnerTaskTasquirre", JSON.stringify(demo));
    return demo;
  }
  return JSON.parse(t);
}

const task = seedPartnerTaskIfEmpty();
const params = new URLSearchParams(location.search);
const taskId = params.get("id") || task.id;
const chatKey = "chat_partner_" + taskId;

/* HEADER INFO */
document.getElementById("chatTitle").textContent = "Chat dengan " + (task.user || "User");
document.getElementById("chatSubtitle").textContent = "Task: " + (task.jobdesk || "-");

/* LOAD CHAT */
let messages = JSON.parse(localStorage.getItem(chatKey) || "[]");

if(messages.length === 0){
  messages.push({
    from:"user",
    text:"Halo, aku mau konfirmasi detail tugas dulu ya ðŸ™‚",
    time:Date.now()
  });
  localStorage.setItem(chatKey, JSON.stringify(messages));
}

function formatTime(ts){
  const d = new Date(ts);
  return d.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
}

function renderChat(){
  const body = document.getElementById("chatBody");
  body.innerHTML = "";

  messages.forEach(msg=>{
    const row = document.createElement("div");
    row.className = "msg-row " + (msg.from==="partner" ? "partner" : "user");

    const bubble = document.createElement("div");
    bubble.className = "msg-bubble " + (msg.from==="partner" ? "msg-partner" : "msg-user");
    bubble.innerHTML = `
      <div>${msg.text}</div>
      <div class="msg-time">${formatTime(msg.time)}</div>
    `;

    row.appendChild(bubble);
    body.appendChild(row);
  });

  body.scrollTop = body.scrollHeight;
}

function sendMessage(){
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if(!text) return;

  messages.push({
    from:"partner",
    text,
    time:Date.now()
  });
  localStorage.setItem(chatKey, JSON.stringify(messages));
  input.value = "";
  renderChat();
}

/* NAV */
function goBack(){
  const s=document.getElementById("screen");
  s.classList.add("fade-out");
  setTimeout(()=>window.location.href=`taskongoing.html?id=${encodeURIComponent(taskId)}`,450);
}

/* INIT */
renderChat();
</script>

</body>
</html>
